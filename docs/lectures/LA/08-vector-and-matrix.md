# 講義8: 2次元データと行列の積

## 1. 講義概要
- **講義時間:** 60分　/　**演習時間:** 30分
- **目的:**  
  2次元データ（各観測が2つの変数からなるデータ）を行列として扱い、ベクトル・行列演算を用いて共分散および相関係数の計算方法を理解する。
- **今日の目標:**  
  ・2次元データの表現方法と、行列・ベクトルを用いた統計量（共分散、相関係数）の計算手法を習得する。  
  ・具体的な計算例を通して、理論と実践の橋渡しを行い、Google Colab上で計算確認できるようになる。

## 2. 理論的背景と内容の説明
### 2.1 定義・基本概念
- **2次元データの表現:**  
  複数の観測値が2つの変数からなる場合、各観測を行ベクトルとして、全体をデータ行列 $X \in \mathbb{R}^{n \times 2}$ として表現する。  
  例：  
  $$
  X = \begin{pmatrix}
  x_{11} & x_{12} \\
  x_{21} & x_{22} \\
  \vdots & \vdots \\
  x_{n1} & x_{n2}
  \end{pmatrix}.
  $$
- **データの平均ベクトル:**  
  各変数の平均を $\bar{x}_1, \bar{x}_2$ として、  
  $$
  \bar{\mathbf{x}} = \begin{pmatrix} \bar{x}_1 \\ \bar{x}_2 \end{pmatrix} = \frac{1}{n} \sum_{i=1}^{n} \begin{pmatrix} x_{i1} \\ x_{i2} \end{pmatrix}.
  $$
- **偏差行列:**  
  各観測から平均を引いた行列は、  
  $$
  X - \mathbf{1}\bar{\mathbf{x}}^T,
  $$
  ここで $\mathbf{1} \in \mathbb{R}^{n}$ は全ての成分が1のベクトル。
- **共分散:**  
  2変量間の共分散は、  
  $$
  \operatorname{Cov}(x_1, x_2) = \frac{1}{n}\sum_{i=1}^n (x_{i1} - \bar{x}_1)(x_{i2} - \bar{x}_2).
  $$
- **相関係数:**  
  共分散を各変数の標準偏差で正規化したもので、  
  $$
  \rho_{x_1,x_2} = \frac{\operatorname{Cov}(x_1, x_2)}{\sigma_{x_1}\sigma_{x_2}},
  $$
  と定義される。

### 2.2 定理・命題
- **共分散行列の定義:**  
  2次元データの場合、共分散行列は  
  $$
  \Sigma = \frac{1}{n}(X - \mathbf{1}\bar{\mathbf{x}}^T)^T (X - \mathbf{1}\bar{\mathbf{x}}^T)
  $$
  と表され、  
  $$
  \Sigma = \begin{pmatrix}
  \operatorname{Var}(x_1) & \operatorname{Cov}(x_1, x_2) \\
  \operatorname{Cov}(x_2, x_1) & \operatorname{Var}(x_2)
  \end{pmatrix}.
  $$
  この行列は必ず対称行列となる。
- **相関係数の範囲:**  
  相関係数は $-1 \leq \rho_{x_1,x_2} \leq 1$ の範囲にあり、値が1または-1の場合は完全な線形関係を意味する。

### 2.3 数式・証明の詳細
- **共分散の行列表示:**  
  平均ベクトル $\bar{\mathbf{x}}$ を用いて偏差行列 $D = X - \mathbf{1}\bar{\mathbf{x}}^T$ を定義すると、  
  $$
  \Sigma = \frac{1}{n}D^T D.
  $$
  この形で計算すると、各要素は  
  $$
  \Sigma_{ij} = \frac{1}{n}\sum_{k=1}^n (x_{ki} - \bar{x}_i)(x_{kj} - \bar{x}_j)
  $$
  となる。
- **相関係数の行列表示:**  
  標準偏差ベクトル $\boldsymbol{\sigma} = (\sigma_{x_1}, \sigma_{x_2})^T$ を用い、  
  $$
  R = \begin{pmatrix}
  1 & \rho_{x_1,x_2} \\
  \rho_{x_1,x_2} & 1
  \end{pmatrix} = \begin{pmatrix}
  \frac{\Sigma_{11}}{\sigma_{x_1}^2} & \frac{\Sigma_{12}}{\sigma_{x_1}\sigma_{x_2}} \\
  \frac{\Sigma_{21}}{\sigma_{x_1}\sigma_{x_2}} & \frac{\Sigma_{22}}{\sigma_{x_2}^2}
  \end{pmatrix}.
  $$

### 2.4 実際の計算
以下は、0〜10点の小テストの得点を用いた具体例と、その計算手順を丁寧に説明したものです。

---

### 【例題】  
以下のデータは、あるクラスの5人の学生の数学と英語の小テストの得点（0〜10点）を表しています。  
各行は1人の学生を表し、1列目が数学、2列目が英語の得点です。

$$
X = \begin{pmatrix}
8 & 6 \\
7 & 8 \\
6 & 5 \\
9 & 7 \\
5 & 4
\end{pmatrix}.
$$

---

### 【ステップ1: 平均ベクトルの計算】

各科目の平均を求めます。

- **数学の平均:**  
  $$\bar{x}_1 = \frac{8+7+6+9+5}{5} = \frac{35}{5} = 7.$$
  
- **英語の平均:**  
  $$\bar{x}_2 = \frac{6+8+5+7+4}{5} = \frac{30}{5} = 6.$$

よって、平均ベクトルは

$$
\bar{\mathbf{x}} = \begin{pmatrix} 7 \\ 6 \end{pmatrix}.
$$

---

### 【ステップ2: 偏差行列の作成】

各観測から平均を引いて、偏差行列 \(D\) を作成します。  
各学生について計算すると、

- 学生1: \((8,\,6) - (7,\,6) = (1,\,0)\)  
- 学生2: \((7,\,8) - (7,\,6) = (0,\,2)\)  
- 学生3: \((6,\,5) - (7,\,6) = (-1,\,-1)\)  
- 学生4: \((9,\,7) - (7,\,6) = (2,\,1)\)  
- 学生5: \((5,\,4) - (7,\,6) = (-2,\,-2)\)

したがって、

$$
D = X - \mathbf{1}\bar{\mathbf{x}}^T = \begin{pmatrix}
1 & 0 \\
0 & 2 \\
-1 & -1 \\
2 & 1 \\
-2 & -2
\end{pmatrix}.
$$

---

### 【ステップ3: 共分散行列の計算】

共分散行列 \(\Sigma\) は、偏差行列 \(D\) を用いて次のように求めます。

$$
\Sigma = \frac{1}{n} D^T D,
$$

ここで \(n = 5\) です。

まず、\(D^T\)（\(D\) の転置）は

$$
D^T = \begin{pmatrix}
1 & 0 & -1 & 2 & -2 \\
0 & 2 & -1 & 1 & -2
\end{pmatrix}.
$$

次に、\(D^T D\) を計算します。

- \((1,1)\) 成分（数学の分散）:
  $$
  (D^T D)_{11} = 1^2 + 0^2 + (-1)^2 + 2^2 + (-2)^2 = 1 + 0 + 1 + 4 + 4 = 10.
  $$
  
- \((1,2)\) 成分（数学と英語の共分散）:
  $$
  (D^T D)_{12} = (1)(0) + (0)(2) + (-1)(-1) + (2)(1) + (-2)(-2) = 0 + 0 + 1 + 2 + 4 = 7.
  $$

- \((2,2)\) 成分（英語の分散）:
  $$
  (D^T D)_{22} = 0^2 + 2^2 + (-1)^2 + 1^2 + (-2)^2 = 0 + 4 + 1 + 1 + 4 = 10.
  $$

対称性より、\((D^T D)_{21} = (D^T D)_{12} = 7\) です。

よって、

$$
D^T D = \begin{pmatrix}
10 & 7 \\
7 & 10
\end{pmatrix}.
$$

共分散行列は、

$$
\Sigma = \frac{1}{5}\begin{pmatrix}
10 & 7 \\
7 & 10
\end{pmatrix} = \begin{pmatrix}
2.0 & 1.4 \\
1.4 & 2.0
\end{pmatrix}.
$$

---

### 【ステップ4: 相関係数の計算】

各科目の標準偏差は、共分散行列の対角成分の平方根で求めます。

- 数学の標準偏差:  
  $$\sigma_{x_1} = \sqrt{2.0} \approx 1.414.$$
  
- 英語の標準偏差:  
  $$\sigma_{x_2} = \sqrt{2.0} \approx 1.414.$$

数学と英語の相関係数 \(\rho_{x_1,x_2}\) は、

$$
\rho_{x_1,x_2} = \frac{\operatorname{Cov}(x_1,x_2)}{\sigma_{x_1}\sigma_{x_2}} = \frac{1.4}{1.414 \times 1.414} \approx \frac{1.4}{2} = 0.7.
$$

---

### 【まとめ】

- **平均ベクトル:**  
  \(\bar{\mathbf{x}} = \begin{pmatrix} 7 \\ 6 \end{pmatrix}\)

- **偏差行列:**  
  \(D = \begin{pmatrix}
  1 & 0 \\
  0 & 2 \\
  -1 & -1 \\
  2 & 1 \\
  -2 & -2
  \end{pmatrix}\)

- **共分散行列:**  
  \(\Sigma = \begin{pmatrix}
  2.0 & 1.4 \\
  1.4 & 2.0
  \end{pmatrix}\)

- **相関係数:**  
  \(\rho_{x_1,x_2} \approx 0.7\)

この手順を通じて、小テストの得点（0〜10点）のデータから、各科目の平均、偏差、共分散、そして相関係数を計算する方法を学びます。これにより、データのばらつきや、2科目間の線形な関係の強さを数理的に理解することができます。

## 3. 扱う内容の実例（GPT, Colab等は使用せず）

- **実例1 (更新版):**  
  異なる科目のテストの点数を用いた2次元データの例を考える。  
  例えば、あるクラスの5人の学生について、数学と英語のテストの点数が以下のように得られたとする。  
  各行は1人の学生、1列目が数学、2列目が英語の点数を示す。  
  $$
  X = \begin{pmatrix}
  70 & 80 \\
  85 & 75 \\
  90 & 95 \\
  60 & 65 \\
  75 & 70
  \end{pmatrix}.
  $$
  このデータを用いて、  
  - 各科目の平均点（平均ベクトル）を求め、  
  - 各学生の点数から平均を引いた偏差行列を作成し、  
  - それらを内積計算することで共分散行列を得る。  
  さらに、各科目の標準偏差を計算し、相関係数も求めることができる。  

### 【例題】  
以下のデータは、あるクラスの5人の学生の数学と英語のテストの点数を表しています。  
各行は1人の学生を、1列目が数学、2列目が英語の点数を示しています。  

$$
X = \begin{pmatrix}
70 & 80 \\
85 & 75 \\
90 & 95 \\
60 & 65 \\
75 & 70
\end{pmatrix}.
$$

---

### 【ステップ1: 平均ベクトルの計算】

各科目ごとに平均を求めます。

- **数学の平均**  
  $$\bar{x}_1 = \frac{70 + 85 + 90 + 60 + 75}{5} = \frac{380}{5} = 76.$$
  
- **英語の平均**  
  $$\bar{x}_2 = \frac{80 + 75 + 95 + 65 + 70}{5} = \frac{385}{5} = 77.$$

よって、平均ベクトルは

$$
\bar{\mathbf{x}} = \begin{pmatrix} 76 \\ 77 \end{pmatrix}.
$$

---

### 【ステップ2: 偏差行列の作成】

各観測から平均を引いて偏差行列 \(D\) を求めます。  
各学生ごとに計算すると、

- 学生1: \((70,80) - (76,77) = (-6,\ 3)\)  
- 学生2: \((85,75) - (76,77) = (9,\ -2)\)  
- 学生3: \((90,95) - (76,77) = (14,\ 18)\)  
- 学生4: \((60,65) - (76,77) = (-16,\ -12)\)  
- 学生5: \((75,70) - (76,77) = (-1,\ -7)\)

したがって、

$$
D = X - \mathbf{1}\bar{\mathbf{x}}^T = \begin{pmatrix}
-6 & 3 \\
9 & -2 \\
14 & 18 \\
-16 & -12 \\
-1 & -7
\end{pmatrix}.
$$

---

### 【ステップ3: 共分散行列の計算】

共分散行列 \(\Sigma\) は、偏差行列 \(D\) を用いて次の式で求めます。

$$
\Sigma = \frac{1}{n} D^T D,
$$

ここで \(n = 5\) です。

まず、\(D^T\)（\(D\)の転置）を求めると、

$$
D^T = \begin{pmatrix}
-6 & 9 & 14 & -16 & -1 \\
3 & -2 & 18 & -12 & -7
\end{pmatrix}.
$$

次に、\(D^T D\) の各成分を計算します。

- \((1,1)\) 成分（数学の分散に相当）:

  $$
  \Sigma_{11} = (-6)^2 + 9^2 + 14^2 + (-16)^2 + (-1)^2 = 36 + 81 + 196 + 256 + 1 = 570.
  $$

- \((1,2)\) 成分（数学と英語の共分散）:

  $$
  \Sigma_{12} = (-6)(3) + (9)(-2) + (14)(18) + (-16)(-12) + (-1)(-7) \\
  = -18 - 18 + 252 + 192 + 7 = 415.
  $$

- \((2,2)\) 成分（英語の分散に相当）:

  $$
  \Sigma_{22} = (3)^2 + (-2)^2 + (18)^2 + (-12)^2 + (-7)^2 = 9 + 4 + 324 + 144 + 49 = 530.
  $$

対称性より \(\Sigma_{21} = \Sigma_{12} = 415\) です。

よって、

$$
D^T D = \begin{pmatrix}
570 & 415 \\
415 & 530
\end{pmatrix}.
$$

最終的に、共分散行列は

$$
\Sigma = \frac{1}{5}\begin{pmatrix}
570 & 415 \\
415 & 530
\end{pmatrix} = \begin{pmatrix}
114 & 83 \\
83 & 106
\end{pmatrix}.
$$

---

### 【ステップ4: 相関係数の計算】

各科目の標準偏差は、共分散行列の対角成分の平方根で求められます。

- 数学の標準偏差:  
  $$\sigma_{x_1} = \sqrt{114} \approx 10.68.$$
  
- 英語の標準偏差:  
  $$\sigma_{x_2} = \sqrt{106} \approx 10.30.$$

数学と英語の相関係数 \(\rho_{x_1, x_2}\) は、

$$
\rho_{x_1, x_2} = \frac{\operatorname{Cov}(x_1,x_2)}{\sigma_{x_1}\sigma_{x_2}} = \frac{83}{10.68 \times 10.30} \approx \frac{83}{109.99} \approx 0.755.
$$

---

### 【まとめ】

- **平均ベクトル:**  
  \(\bar{\mathbf{x}} = (76, 77)^T\)

- **偏差行列:**  
  \(D = \begin{pmatrix}
  -6 & 3 \\
  9 & -2 \\
  14 & 18 \\
  -16 & -12 \\
  -1 & -7
  \end{pmatrix}\)

- **共分散行列:**  
  \(\Sigma = \begin{pmatrix}
  114 & 83 \\
  83 & 106
  \end{pmatrix}\)

- **相関係数:**  
  \(\rho_{x_1,x_2} \approx 0.755\)

この計算を通して、異なる科目（数学と英語）の点数のばらつきや、両者の線形な関係の強さがどのように数式により表現されるかを理解できます。

- **実例2:**  
  日常生活からの興味深い例として、夏のある地域における日別の気温とアイスクリームの売上データを考える。  
  例えば、以下のようなデータが得られたとする：
  $$
  X = \begin{pmatrix}
  30 & 100 \\
  32 & 110 \\
  31 & 105 \\
  29 &  95 \\
  28 &  90 \\
  33 & 115 \\
  34 & 120
  \end{pmatrix},
  $$
  ここで各行は1日分の観測で、1列目が気温（℃）、2列目がアイスクリームの売上（単位：個数）を示す。  
  このデータを用いて、気温と売上の平均、偏差行列、共分散行列、さらには相関係数を計算すると、気温が上がるとアイスクリームの売上も増加するという正の相関が確認される。  


## 4. ChatGPTによる解説＋Colabでの実行例
- **ChatGPT解説:**  
  2次元データを行列で表現することで、各変数の平均や偏差を一括して扱うことができ、共分散行列も内積計算により効率的に求めることが可能となる。  
  相関係数は、共分散を各変数の標準偏差で割ることで得られ、データの線形関係の強さや方向性を示す指標となる。
- **Colab実行例:** 以下に、PythonとNumPyを用いたサンプルコードを示す。
  ```python
  import numpy as np

  # サンプル2次元データ: 各行が1つの観測、各列が変数
  X = np.array([
      [2, 3],
      [4, 5],
      [6, 7],
      [8, 9]
  ])

  n = X.shape[0]

  # 各変数の平均を計算
  mean = np.mean(X, axis=0)
  print("平均ベクトル:", mean)

  # 偏差行列の計算
  D = X - mean
  print("偏差行列:\n", D)

  # 共分散行列の計算（母分散の場合）
  cov_matrix = (D.T @ D) / n
  print("共分散行列:\n", cov_matrix)

  # 各変数の標準偏差の計算
  std_dev = np.sqrt(np.diag(cov_matrix))
  print("標準偏差:", std_dev)

  # 相関係数の計算
  corr_matrix = cov_matrix / np.outer(std_dev, std_dev)
  print("相関係数行列:\n", corr_matrix)
  ```

## 5. 学んだ内容の応用例（optional)
- **応用分野:**  
  多変量解析、主成分分析（PCA）、金融リスク管理、機械学習の特徴量解析など
- **具体例:**  
  - **PCA:** 共分散行列の固有値分解により、データの次元削減と主要な変動方向を求める。  
  - **ポートフォリオ最適化:** 資産間の相関関係を用いてリスクの低減を図る。  
  - **画像処理:** 複数の画像特徴量の相関を解析することで、ノイズ除去や特徴抽出に応用。

## 6. 演習問題
- **問題1:**  
  2次元データの定義と、平均ベクトル・偏差行列の求め方について説明せよ。  
  *【ヒント】* 行列 $X$ の各列の平均を求め、全体から引く操作を考える。
- **問題2:**  
  以下のデータを用いて、手計算およびPythonコードで共分散行列と相関係数行列を求めよ。  
  $$
  X = \begin{pmatrix}
  -3 & 2 \\
  -1 & 0 \\
  0 & -2 \\
  2 & 3 \\
  3 & -1
  \end{pmatrix}.
  $$
  *【ヒント】* 平均ベクトル、偏差行列、内積を用いた計算過程を明示せよ。
- **問題3:**  
  行列とベクトルの演算を用いて、共分散行列の対称性および相関係数の範囲（-1から1）について説明せよ。
- **問題4:**  
  2次元データにおいて、共分散が正の場合、負の場合、0の場合の意味を考察せよ。
  *【ヒント】* 変数間の線形関係の強さと方向性に注目する。

- **問題5:**  
  以下のデータは、ある変数 \( x \) の値が  
  $$
  x = (-3,\ -2,\ -1,\ 0,\ 1,\ 2,\ 3)
  $$  
  であり、対応する \( y \) の値は  
  $$
  y = x^2,
  $$  
  すなわち  
  $$
  y = (9,\ 4,\ 1,\ 0,\ 1,\ 4,\ 9)
  $$  
  となっています。  

  1. このデータを用いて、\( x \) と \( y \) のピアソンの相関係数を手計算またはプログラムで求めなさい。  
  2. 得られた相関係数の値から、相関係数が「線形な関係しか捉えられない」ことを踏まえて、なぜこの場合に明らかな非線形な関係（\( y = x^2 \)）が反映されないのかを説明しなさい。  

  *【ヒント】*  
  - \( x \) の値は対称に分布しているため、\( x \) と \( x^2 \) の共分散がゼロになる可能性があります。  
  - ピアソンの相関係数は、線形関係の強さを示す指標であり、非線形な関係（例えば、二次関数）の場合、その関係性を十分に反映できないことに注意してください。
