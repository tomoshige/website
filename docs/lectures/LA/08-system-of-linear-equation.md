# 講義8: ランクの概念とその計算

## 1. 本日扱う内容について（概要）
- **目的:**  
    - 行列の階段行列（Row Echelon Form, REF）および簡約階段行列（Reduced Row Echelon Form, RREF）の定義とその導出方法を理解する  
    - ピボットの概念を明確にし、非正方行列（例：5×3行列、3×4行列）を例に、行基本変形によって簡約階段行列に変形する手順を学ぶ  
    - 行列のランクの定義と、その計算方法を習得する

- **講義の流れ:**  
    1. 連立一次方程式の行列表現と拡大係数行列の復習（必要に応じて）  
    2. 階段行列および簡約階段行列の定義とピボットの概念の説明  
    3. 非正方行列（5×3行列、3×4行列）の例を用いて、階段行列と簡約階段行列の例、ならびにそれらでない例も紹介  
    4. 行基本変形による簡約階段行列の導出方法の説明  
    5. 行列のランクの定義と、非正方行列におけるランクの計算方法の解説  
    6. ChatGPTによる解説＋Google Colabでの実装例  
    7. 学んだ内容の応用例  
    8. 演習問題

---

## 2. 扱う内容の理論の説明（定義・定理・数式を含む）
今回の講義では、一度連立方程式から離れて一般的な行列を扱います（あとで連立方程式にも適用されます）。そのため、今回の講義では行列の行の数$m$ と列の数$n$は等しいとは限らないという状況を想定しましょう。

### 階段行列 (Row Echelon Form, REF)
- **定義:**  
    行列 $ A = [a_{ij}] $ が階段行列であるとは、以下の条件を満たすときに言います：  
    1. すべての零行（全ての成分が 0 の行）は、非零行の下にある。
    2. 各非零行の最初の非零成分（ピボット）の位置は、上の行よりも右にある。

前回の連立方程式では、この階段形式に直すという操作を行って、解を求めました（ガウスの消去法）。階段行列は前回の連立方程式のような**きれいな段々**の形とは限らず、段が飛び飛びになるような場合もあります。次の例で、階段行列の例を通して理解を深めてください。

### 簡約階段行列 (Reduced Row Echelon Form, RREF)
- **定義:**  
    階段行列がさらに以下の条件を満たすとき、簡約階段行列と呼びます：  
    1. 各ピボットは 1 である。  
    2. 各ピボットの上および下のすべての要素は 0 である（すなわち、各ピボットはその列で唯一の非零成分である）。

階段行列に対して、さらに基本操作をすることによって簡約階段行列を導くことができます。
この「簡約階段行列」は、行列に対してただ1つしかなく、一意に定まることが知られています。
今回の講義の目標は、**行列$A$を基本操作によって簡約階段行列に変形する**ことです。

### 簡約階段行列への変形
- **定理**
    どんな行列であっても、行に対して基本変形を行うことによって、簡約階段行列へと変形することができる。
    また、行列に対して簡約階段行列はただ1つしかなく、一意に定まる。

### ピボット (Pivot)
- **定義:**  
    階段行列または簡約階段行列において、各非零行の最初の非零成分をピボットという。

### 行列のランク (Rank)
- **定義:**
    行列のランクとは、行基本変形を施して得られる（簡約）階段行列における非零行の数です。
    行列$A$のランクが$2$であることを、$rank(A)=2$と書きます。

行列のランクは、その行列が持つ線形独立な行（または列）の最大個数であり（後で勉強します）、連立一次方程式の解の性質の判定に利用されます。

---

## 3. 扱う内容の例（実例を提示、GPT, Colabなどは利用しない）

### 階段行列である例と、階段行列ではない例
- **階段行列の例:**  
    $$
    \begin{pmatrix}
    2 & 2 & 0 & 2\\\
    0 & 3 & 4 & 1\\\
    0 & 0 & 0 & 0
    \end{pmatrix}
    $$
    は階段行列です。まず全て$0$の行は、少なくとも1つは$0$ではない行よりも下にあります。次に、各行の最初に出てくる$0$ではない数字の下側は、$0$になっています。よって、階段行列の性質を満たすことがわかります。また、ランクは少なくとも1つの要素が$0$ではない行の数なので、$rank(A) = 2$です。

- **階段行列ではない例:**  
    $$
    \begin{pmatrix}
    2 & 2 & 0 & 2\\\
    1 & 3 & 4 & 1\\\
    0 & 0 & 0 & 0
    \end{pmatrix}
    $$
    は階段行列ではありません。第1行のピボットである$2$の下の行に$1$があります。階段行列は、上の段のピボットの列に着目した時、ピボットより下の行の数字はすべて$0$である必要があります。この状態からは、ランクは計算できません。ランクを計算するためには、この行列を後で説明する行に対して基本操作を行い、階段行列または簡約階段行列にする必要があります。

- **階段行列ではない例:**  
    $$
    \begin{pmatrix}
    2 & 2 & 0 & 2\\\
    0 & 0 & 0 & 0\\\
    0 & 3 & 4 & 1
    \end{pmatrix}
    $$
    は階段行列ではありません。第2行は全ての要素が$0$です。全ての要素が$0$の行は、少なくとも1つの要素が$0$ではない行よりも下になければなりません。よって、これは階段行列ではありません。この状態からは、ランクは計算できません。ランクを計算するためには、この行列を後で説明する行に対して基本操作を行い、階段行列または簡約階段行列にする必要があります。

- **階段行列の例:**  
    $$
    \begin{pmatrix}
    2 & 2 & 0 & 2\\\
    0 & 0 & 1 & 1\\\
    0 & 0 & 0 & 0
    \end{pmatrix}
    $$
    は階段行列です。2行目の2つの目の要素が$0$なので、戸惑うかもしれません。階段行列では、各行の$0$ではない先頭の数字の下が$0$になっていればよいので、この行列はその性質を満たします。よって階段行列です。また、ランクは少なくとも1つの要素が$0$ではない行の数なので、$rank(A) = 2$です。

- **階段行列の例:**  
    $$
    \begin{pmatrix}
    0 & 2 & 0 & 2\\\
    0 & 0 & 0 & 1\\\
    0 & 0 & 0 & 0
    \end{pmatrix}
    $$
    は階段行列です。階段行列で勘違いしがちなことですが、第1行目の最初の要素が$0$でも大丈夫？ということがあります。大丈夫です。階段行列であるための条件に、第1行目の第1要素が$0$ではいけないとは書いていません。第1行目のピボットである$2$の下は$0$になっていますし、第2行目のピボット$1$の下側は$0$になっているので、階段行列の性質を満たします。また、ランクは少なくとも1つの要素が$0$ではない行の数なので、$rank(A) = 2$です。

### 例: 簡約階段行列である例と、簡約階段行列ではない例
次は簡約階段行列について説明します。簡約階段行列は、階段行列であることは大前提で、ピボットの数字が`1`であることと、各行のピボットの上と下が$0$であることが条件です。

- **簡約階段行列の例:**  
    $$
    \begin{pmatrix}
    1 & 0 & 0 & 2\\\
    0 & 1 & 4 & 1\\\
    0 & 0 & 0 & 0
    \end{pmatrix}
    $$
    まず、階段行列の性質は満たされることがわかります。その上で、簡約階段行列の性質を満たすかを確認すると、各行のピボットは$1$になっています。さらに第1行と第2行のピボットの上・下の数字はすべて$0$となっています。よって、簡約階段行列です。

- **簡約階段行列ではない例:**  
    $$
    \begin{pmatrix}
    1 & 2 & 0 & 2\\\
    0 & 1 & 4 & 1\\\
    0 & 0 & 0 & 0
    \end{pmatrix}
    $$
    まず、階段行列の性質は満たされることがわかります。その上で、簡約階段行列の性質を満たすかを確認すると、第2行のピボットの上の数字$0$になっていません。よって、簡約階段行列ではありません。

- **簡約階段行列ではない例:**  
    $$
    \begin{pmatrix}
    1 & 0 & 0 & 2\\\
    0 & 2 & 4 & 1\\\
    0 & 0 & 0 & 0
    \end{pmatrix}
    $$
    まず、階段行列の性質は満たされることがわかります。その上で、簡約階段行列の性質を満たすかを確認すると、第2行のピボットの数字が、$1$ではなく$2$になっています。よって、簡約階段行列ではありません。

### 例: 簡約階段行列の導き方
例として、次の行列$A$を簡約階段行列へと変形するという問題を考えます。
$$
A = \begin{pmatrix}
1 & 2 & 3 \\\
0 & 1 & 4 \\\
2 & 4 & 8 \\\
-1 & -2 & -3 \\\
3 & 5 & 7
\end{pmatrix}
$$
- **解説:**  
    行に対して基本操作を用いて、簡約階段形にする手順は、(1) まずは階段形を作る、(2) その後で簡約階段形を作る。という2つのステップで行います。
    階段形を作るのは、連立方程式を解く際のガウスの消去法と同様の操作を行っていきます。
    まずは、行列$A$に対して、(1,1)要素がすでに$1$になっているので、その下の要素をすべて$0$にしましょう。
    - 3行目から1行目の2倍を引く
    - 4行目に、1行目を加える
    - 5行目から、1行目の3倍を引く
    $$
    A = \begin{pmatrix}
    1 & 2 & 3 \\\
    0 & 1 & 4 \\\
    0 & 0 & 2 \\\
    0 & 0 & 0 \\\
    0 & -1 & -2
    \end{pmatrix}
    $$
    次に、(2,2)要素がすでに$1$になっているので、その下の要素をすべて$0$にしましょう。
    - 5行目に、2行目を加える。
    $$
    A = \begin{pmatrix}
    1 & 2 & 3 \\\
    0 & 1 & 4 \\\
    0 & 0 & 2 \\\
    0 & 0 & 0 \\\
    0 & 0 & 2
    \end{pmatrix}
    $$
    最後に、(3,3)要素に着目すると$2$になっていて、その下の要素を$0$にしましょう。
    - 5行目から、3行目を引く
    $$
    A = \begin{pmatrix}
    1 & 2 & 3 \\\
    0 & 1 & 4 \\\
    0 & 0 & 2 \\\
    0 & 0 & 0 \\\
    0 & 0 & 0
    \end{pmatrix}
    $$
    これで階段行列が完成しました。次に、各行のピボットを$1$にしましょう。
    - 第3行を2で割ります。
    $$
    A = \begin{pmatrix}
    1 & 2 & 3 \\\
    0 & 1 & 4 \\\
    0 & 0 & 1 \\\
    0 & 0 & 0 \\\
    0 & 0 & 0
    \end{pmatrix}
    $$
    そして、各行のピボットの上と下の要素を$0$にします。
    - 第3行の -3倍を、第1行に加えます。
    - 第3行の -4倍を、第2行に加えます。
    $$
    A = \begin{pmatrix}
    1 & 2 & 0 \\\
    0 & 1 & 0 \\\
    0 & 0 & 1 \\\
    0 & 0 & 0 \\\
    0 & 0 & 0
    \end{pmatrix}
    $$
    次に、
    - 第2行の -2倍を、第1行に加えます。
    $$
    A = \begin{pmatrix}
    1 & 0 & 0 \\\
    0 & 1 & 0 \\\
    0 & 0 & 1 \\\
    0 & 0 & 0 \\\
    0 & 0 & 0
    \end{pmatrix}
    $$
    これで、簡約階段形になりました。また、この行列のランクは、非ゼロな行の数なので、$rank(A) = 3$です。

### 例2: 3×4 行列の例
別の例も考えてみましょう。次は、$3 \times 4$行列を簡約階段行列に変形します。
$$
A = \begin{pmatrix}
2 & 4 & 6 & 8 \\\
1 & 3 & 5 & 7 \\\
0 & 1 & 1 & 2
\end{pmatrix}
$$
- **解説:**  
    先ほど同様に考えます。(1) まずは階段形を作る、(2) その後で簡約階段形を作る。という2つのステップで行います。
    階段形を作るのは、連立方程式を解く際のガウスの消去法と同様の操作を行っていきます。
    まずは、行列$A$に対して、第2行の先頭(2,1)要素が$1$になっているので、この行を第1行と入れ替えます。
    $$
    A = \begin{pmatrix}
    1 & 3 & 5 & 7 \\\
    2 & 4 & 6 & 8 \\\
    0 & 1 & 2 & 3
    \end{pmatrix}
    $$
    次に、第1行のピボットの下を$0$にします。

    - 2行目から、1行目の2倍を引く。
    
    $$
    A = \begin{pmatrix}
    1 & 3 & 5 & 7 \\\
    0 & -2 & -4 & -6 \\\
    0 & 1 & 2 & 3
    \end{pmatrix}
    $$
    
    つぎに、第2行の(2,2)要素を$1$にしたいので、
    
    - 3行目と2行目を入れ替えます。
    
    $$
    A = \begin{pmatrix}
    1 & 3 & 5 & 7 \\\
    0 & 1 & 2 & 3 \\\
    0 & -2 & -4 & -6
    \end{pmatrix}
    $$
    
    次に、第2行のピボットの下の要素を$0$にします。
    
    - 第3行に、第2行の2倍を加えます。
    
    $$
    A = \begin{pmatrix}
    1 & 3 & 5 & 7 \\\
    0 & 1 & 2 & 3 \\\
    0 & 0 & 0 & 0
    \end{pmatrix}
    $$
    
    偶然、第3行目がすべて$0$になったので、これで階段行列が完成しました。次に簡約階段行列へ変形します。
    そのためには、各ピボットの上・下の要素が$0$にする必要があります。よって、
    
    - 第1行から、第2行の3倍を引きます。
    
    $$
    A = \begin{pmatrix}
    1 & 0 & -1 & -2 \\\
    0 & 1 & 2 & 3 \\\
    0 & 0 & 0 & 0
    \end{pmatrix}
    $$
    これで、簡約階段形になりました。また、この行列のランクは、非ゼロな行の数なので、$rank(A) = 2$です。

---

## 4. ChatGPTによる解説＋Google Colab での実行例

### ChatGPTによる解説
- **ポイント:**  
    - 行基本変形（行の入れ替え、定数倍、加減）を用いて、任意の行列を簡約階段行列 (RREF) に変形する過程で、各ピボットがどこに現れるかを追跡することが重要です。  
    - 非正方行列の場合でも、変形後の非零行の数がその行列のランクとなり、これが線形独立な行の数や列の次元に対応します。

### Google Colabでの実装例（非正方行列のランク計算）
以下のコード例では、5×3 行列と 3×4 行列それぞれの階段行列に変形し、ランクを求める過程を途中の過程を print で表示しながら示します。

```python
import numpy as np

def rref_verbose(A):
    """
    行列 A を簡約階段行列 (RREF) に変換し、途中の変形過程を表示する関数。
    入力:
      A: 行列 (形状: (m, n))
    出力:
      A_rref: A の RREF, rank: 非零行の数
    """
    A = A.copy().astype(float)
    m, n = A.shape
    pivot_row = 0
    # --- 前進消去 (Forward Elimination) ---
    for j in range(n):
        # 部分ピボット選択: 列 j で、pivot_row 以降の行の中で最大の絶対値を持つ行を選ぶ
        max_row = pivot_row + np.argmax(np.abs(A[pivot_row:, j]))
        if np.isclose(A[max_row, j], 0):
            continue  # この列は全て 0 ならスキップ
        # 行の入れ替え
        A[[pivot_row, max_row]] = A[[max_row, pivot_row]]
        print(f"\n列 {j}: 行 {pivot_row} と 行 {max_row} を入れ替えた後:")
        print(A)
        # ピボット行を正規化（ピボットを 1 にする）
        pivot = A[pivot_row, j]
        A[pivot_row] = A[pivot_row] / pivot
        print(f"\n列 {j}: 行 {pivot_row} を {pivot:.3f} で割って正規化した後:")
        print(A)
        # 下の行の消去: ピボット列 j の下部の要素を 0 にする
        for i in range(pivot_row + 1, m):
            factor = A[i, j]
            A[i] = A[i] - factor * A[pivot_row]
            print(f"\n列 {j}: 行 {i} から {factor:.3f}×行 {pivot_row} を引いた後:")
            print(A)
        pivot_row += 1
        if pivot_row == m:
            break

    # --- 後退消去 (Backward Elimination) ---
    for j in range(n - 1, -1, -1):
        # ピボットが存在する行を探す
        pivot_rows = np.where(~np.isclose(A[:, j], 0))[0]
        if len(pivot_rows) == 0:
            continue
        pivot_row = pivot_rows[0]  # 最上位のピボット行
        # pivot_row より上の各行で、列 j の要素を 0 にする
        for i in range(0, pivot_row):
            factor = A[i, j]
            A[i] = A[i] - factor * A[pivot_row]
            print(f"\n上部消去: 行 {i} から {factor:.3f}×行 {pivot_row} を引いて列 {j} を 0 にした後:")
            print(A)
    
    # ランクの計算：非零行の数
    rank = np.sum(~np.all(np.isclose(A, 0), axis=1))
    return A, rank

# --- 使用例 ---

# 例1: 5×3 行列の例
A_5x3 = np.array([
    [1, 2, 3],
    [0, 1, 4],
    [2, 4, 8],
    [-1, -2, -3],
    [3, 5, 7]
], dtype=float)

print("=== 5×3 行列の RREF とランク ===")
rref_5x3, rank_5x3 = rref_verbose(A_5x3)
print("\n最終的な RREF (5×3 行列):")
print(rref_5x3)
print(f"5×3 行列のランク: {rank_5x3}\n")

# 例2: 3×4 行列の例
A_3x4 = np.array([
    [2, 4, 6, 8],
    [1, 3, 5, 7],
    [0, 1, 1, 2]
], dtype=float)

print("=== 3×4 行列の RREF とランク ===")
rref_3x4, rank_3x4 = rref_verbose(A_3x4)
print("\n最終的な RREF (3×4 行列):")
print(rref_3x4)
print(f"3×4 行列のランク: {rank_3x4}")
```

---

## 5. 学んだ内容がどのように応用されるか
- **工学・物理学:**  
    システムの自由度や制約条件の数を評価するため、行列のランクは重要な役割を果たします。  
- **経済学・最適化:**  
    連立一次方程式のランクにより、解の存在性や一意性、または無限解の存在などを判定できます。  
- **コンピュータグラフィックス:**  
    変換行列のランクを調べることで、射影やその他の変換の情報量を評価できます。  
- **機械学習:**  
    データ行列のランクは、次元削減（例えば PCA）や特徴選択の際に、データの冗長性を判断する指標として利用されます。

---

## 6. 演習問題
1. **演習問題1:**  
    以下の 5×3 行列
    $$
    A_{5\times3} = \begin{pmatrix}
    1 & 2 & 3 \\\
    0 & 1 & 4 \\\
    2 & 4 & 8 \\\
    -1 & -2 & -3 \\\
    3 & 5 & 7
    \end{pmatrix}
    $$
    を RREF に変形し、その途中過程と最終的なランクを求めよ。

2. **演習問題2:**  
    次の 3×4 行列
    $$
    A_{3\times4} = \begin{pmatrix}
    2 & 4 & 6 & 8 \\\
    1 & 3 & 5 & 7 \\\
    0 & 1 & 1 & 2
    \end{pmatrix}
    $$
    を RREF に変形し、その途中過程と最終的なランクを求めよ。

3. **演習問題3:**  
    階段行列および簡約階段行列の定義を自分の言葉で説明し、以下の行列がそれぞれどの形式に当てはまるかを判断せよ：
    - $ \begin{pmatrix} 1 & 2 & 0 \\\ 0 & 3 & 4 \\\ 0 & 0 & 5 \end{pmatrix} $
    - $ \begin{pmatrix} 1 & 0 & 2 \\\ 0 & 1 & -3 \\\ 0 & 0 & 0 \end{pmatrix} $
    - $ \begin{pmatrix} 0 & 1 & 2 \\\ 1 & 3 & 4 \\\ 0 & 0 & 5 \end{pmatrix} $

4. **演習問題4:**  
    Google Colab 上で、今回のガウスの消去法の実装コードを自分で実装し、非正方行列（5×3 行列または 3×4 行列）の RREF 変形過程を記録せよ。その結果、得られる RREF とランクを報告せよ。

---