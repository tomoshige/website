# 講義24: 正規直交基底と射影

## 1. 講義概要
- **講義時間:** 60分　/　**演習時間:** 30分
- **目的:**  
  正規直交基底の復習を踏まえ、ベクトル空間の直和分解や直交直和分解、直交補空間の概念を理解し、これらと直交射影および射影行列の関係性を明らかにする。また、線形回帰モデルにおける直交射影行列の役割について学び、シミュレーションを通して直感的な理解を深める。
- **今日の目標:**  
  ・正規直交基底の復習と、ベクトル空間の直和分解・直交補空間の定義を確認する  
  ・直交射影の定義と、その計算方法（射影行列の導出）を理解する  
  ・線形回帰モデルにおける直交射影行列の意味と応用例を整理する  
  ・Google Colab を用いて、直和分解と直交射影のシミュレーションを実施する

## 2. 理論的背景と内容の説明
### 2.1 定義・基本概念
- **正規直交基底（復習）:**  
  内積空間 $V$ の基底 $\{e_1, e_2, \dots, e_n\}$ が各 $i$ について $\|e_i\|=1$、かつ $i \neq j$ のとき $\langle e_i,e_j\rangle=0$ ならば、これを正規直交基底と呼ぶ。
  
- **直和分解と直交直和分解:**  
  ベクトル空間 $V$ が部分空間 $W$ とその直交補空間 $W^\perp$ により  
  $$
  V = W \oplus W^\perp
  $$
  と一意的に分解できる場合、これを直交直和分解と呼ぶ。  
  ここで、$W^\perp$ とは  
  $$
  W^\perp = \{v\in V \mid \langle v, w \rangle = 0 \quad \forall\, w\in W\}
  $$
  で定義される。

- **直交射影:**  
  内積空間 $V$ において、任意の $v\in V$ は直交直和分解 $v = w + w^\perp$ （$w\in W,\; w^\perp \in W^\perp$）が成り立つ。ここで、$w$ を $v$ の $W$ への直交射影と呼ぶ。

- **射影行列:**  
  部分空間 $W$ に対して、任意の $v\in V$ を $W$ 上に射影する線形変換 $P:V\to W$ を射影と呼ぶ。  
  $W$ の正規直交基底 $\{e_1,\dots,e_k\}$ を用いると、  
  $$
  P(v)=\sum_{i=1}^{k}\langle v, e_i\rangle e_i
  $$
  と表され、この変換に対応する行列は  
  $$
  P = E E^T,
  $$
  （$E$ は各列が $e_i$ である行列）と書ける。  
  射影行列は $P^2=P$ を満たす（冪等性）。

- **線形回帰モデルにおける直交射影:**  
  線形回帰モデルでは、観測ベクトル $y\in\mathbb{R}^n$ を説明変数の行列 $X\in\mathbb{R}^{n\times p}$ の列空間に射影して予測値 $\hat{y}$ を求める。  
  このとき、射影行列は  
  $$
  P = X (X^TX)^{-1} X^T
  $$
  と表され、$\hat{y}=Py$ となる。

### 2.2 定理・命題
- **射影の一意性（直交分解定理）:**  
  任意の $v\in V$ に対して、$V = W \oplus W^\perp$ と一意に分解できる。これにより、$W$ への直交射影は一意的に定義される。
  
- **射影行列の性質:**  
  射影行列 $P$ は  
  - 冪等性: $P^2 = P$  
  - 対称性（直交射影の場合）: $P^T = P$  
  を満たす。これらの性質は、正規直交基底を用いて構成された射影行列に特有である。

### 2.3 数式・証明の詳細
- **直交射影の数式:**  
  内積空間 $V$ の部分空間 $W$ の正規直交基底 $\{e_1, \dots, e_k\}$ に対して、任意の $v\in V$ の $W$ への直交射影は  
  $$
  P(v)=\sum_{i=1}^{k}\langle v,e_i\rangle e_i.
  $$
  これを行列表示すると、$E=[e_1 \, e_2 \, \cdots \, e_k]$ として  
  $$
  P = E E^T.
  $$
  
- **線形回帰における射影行列の導出:**  
  回帰モデル $y=X\beta+\varepsilon$ において、最小二乗解は  
  $$
  \hat{\beta} = (X^TX)^{-1}X^Ty,
  $$
  で与えられ、予測値は  
  $$
  \hat{y} = X\hat{\beta} = X(X^TX)^{-1}X^Ty = Py.
  $$
  ここで、$P = X(X^TX)^{-1}X^T$ は直交射影行列であり、$\hat{y}$ は $y$ の $X$ の列空間への直交射影となる。

## 3. 扱う内容の実例（GPT, Colab等は使用せず）
- **実例1: 直和分解と直交射影の計算**  
  例として、$\mathbb{R}^2$ の部分空間 $W=\{(x,0)\mid x\in\mathbb{R}\}$ を考える。  
  任意のベクトル $v=(x,y)$ は  
  $$
  v=(x,0)+(0,y)
  $$
  と直和分解できる。ここで、$(x,0)$ が $W$ への直交射影となる。射影行列は  
  $$
  P=\begin{pmatrix}1 & 0\\0 & 0\end{pmatrix}
  $$
  となり、$Pv=(x,0)$ を与える。

- **実例2: 線形回帰モデルにおける射影行列の例**  
  説明変数行列  
  $$
  X=\begin{pmatrix} 1 & x_1 \\ 1 & x_2 \\ \vdots & \vdots \\ 1 & x_n \end{pmatrix}
  $$
  を用いる単回帰モデルを考える。最小二乗推定により射影行列  
  $$
  P = X(X^TX)^{-1}X^T
  $$
  を計算し、観測値 $y\in\mathbb{R}^n$ を $X$ の列空間に射影して得られる予測値 $\hat{y}=Py$ を確認する。ホワイトボードでは、具体的な数値例を用いて $P$ の計算過程とその性質（$P^2=P,\;P^T=P$）を示す。

## 4. ChatGPTによる解説＋Colabでの実行例
- **ChatGPT解説:**  
  正規直交基底は、内積空間の射影計算や直和分解を行う上で非常に有用です。  
  ・直和分解により、任意のベクトルは部分空間とその直交補空間に一意に分解でき、そのうちの部分を射影として取り出すことができます。  
  ・射影行列はその計算を行列形式で表現するもので、特に直交射影の場合は冪等性と対称性を持つため、解析的にも数値的にも扱いやすい。  
  ・線形回帰モデルでは、データの予測値が観測値の直交射影として解釈できるため、統計学的にも重要な役割を果たします。  
  理論と実例を通して、射影の意味とその計算方法を体感することが学習の鍵です。

- **Colab実行例:**  
  以下は、Python (numpy, matplotlib) を用いて直和分解と直交射影のシミュレーション、さらに線形回帰における射影行列の動作を確認するサンプルコードです。
  ```python
  import numpy as np
  import matplotlib.pyplot as plt

  # --- 直和分解と直交射影の例（2次元） ---
  # 部分空間 W: x軸
  def project_onto_W(v):
      # 射影行列 P = [[1, 0], [0, 0]]
      P = np.array([[1, 0], [0, 0]])
      return P @ v

  # 任意のベクトル v
  v = np.array([3, 2])
  proj_v = project_onto_W(v)
  print("元のベクトル:", v)
  print("Wへの直交射影:", proj_v)

  # 可視化
  plt.figure(figsize=(6,6))
  origin = [0, 0]
  plt.quiver(*origin, *v, angles='xy', scale_units='xy', scale=1, color='r', label='v')
  plt.quiver(*origin, *proj_v, angles='xy', scale_units='xy', scale=1, color='b', label='Projection onto W')
  plt.xlim(-5, 5)
  plt.ylim(-5, 5)
  plt.xlabel('x')
  plt.ylabel('y')
  plt.title('直和分解と直交射影の例')
  plt.grid(True)
  plt.legend()
  plt.show()

  # --- 線形回帰における射影行列の例 ---
  # サンプルデータ（単回帰モデル）
  x = np.linspace(0, 10, 20)
  X = np.column_stack((np.ones_like(x), x))
  # 真のパラメータとノイズ付き観測値
  beta_true = np.array([2, 0.5])
  noise = np.random.randn(len(x)) * 0.5
  y = X @ beta_true + noise

  # 射影行列 P = X(X^TX)^{-1}X^T の計算
  P = X @ np.linalg.inv(X.T @ X) @ X.T
  y_hat = P @ y

  print("観測値 y:", y)
  print("予測値 y_hat:", y_hat)

  # 可視化：観測値と回帰直線（射影による予測）
  plt.figure(figsize=(8,6))
  plt.scatter(x, y, color='gray', label='観測値')
  plt.plot(x, y_hat, color='r', label='射影による予測')
  plt.xlabel('x')
  plt.ylabel('y')
  plt.title('線形回帰モデルにおける射影行列の例')
  plt.legend()
  plt.show()
  ```
  このコードでは、2次元空間での直交射影の基本例と、線形回帰モデルにおける射影行列の動作を確認できます。

## 5. 学んだ内容の応用例（optional)
- **応用分野:**  
  ・コンピュータグラフィックス：光の反射や影の計算における平面への射影  
  ・機械学習：次元削減（PCA）や特徴抽出、線形回帰モデルにおける予測  
  ・統計解析：回帰分析、分散分析における射影行列の利用  
- **具体例:**  
  線形回帰モデルでは、観測値が説明変数の列空間に直交射影されることで、残差の最小二乗性が保証される。この性質は、データのフィッティングや信号処理のノイズ除去にも応用される。

## 6. 演習問題
- **問題1:**  
  正規直交基底の定義を復習し、内積空間 $V$ の任意の部分空間 $W$ に対して、$V = W \oplus W^\perp$ が成立する理由を証明せよ。  
  ※ヒント: 射影定理と内積の性質（線形性、対称性、正定値性）を利用すること。

- **問題2:**  
  2次元空間で、任意のベクトル $v=(x,y)$ に対して $W=\{(x,0)\mid x\in\mathbb{R}\}$ への直交射影を計算し、その射影行列 $P$ を導出せよ。  
  ※ヒント: $P$ が冪等かつ対称であることを確認すること。

- **問題3:**  
  線形回帰モデルにおける射影行列  
  $$
  P = X(X^TX)^{-1}X^T
  $$
  の性質（冪等性・対称性）を示し、予測値 $\hat{y}=Py$ の解釈について説明せよ。  
  ※ヒント: 射影行列の固有値や行列の基本性質に着目すること。

- **問題4:**  
  Google Colab を用いて、直和分解のシミュレーションおよび直交射影のシミュレーションを実装し、得られたグラフから各射影の意味と応用例について考察せよ。  
  ※ヒント: シミュレーション結果から、ベクトルがどのように部分空間に分解されるかを視覚的に説明すること。